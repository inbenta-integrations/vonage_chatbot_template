### OBJECTIVE

This Nexmo connector extends from the [Chatbot API Connector](https://github.com/inbenta-integrations/chatbot_api_connector) library. This library includes a Nexmo API Client in order to send messages to WhatsApp users through our WhatsApp phone number. It translates WhatsApp's messages into the Inbenta Chatbot API format and vice versa. Also, it implements some methods from the base HyperChat client in order to communicate with WhatsApp when the user is chatting.

### FUNCTIONALITIES
This connector inherits the functionalities from the `ChatbotConnector` library. Currently, the features provided by this application are:

* Simple answers
* Multiple options with a limit of 3 elements
* Polar questions
* Chained answers
* Content ratings (yes/no + comment)
* Escalate to HyperChat after a number of no-results answers
* Escalate to HyperChat when matching with an 'Escalation FAQ'
* Send information to webhook through forms

### HOW TO CUSTOMIZE

**Custom Behaviors**

If you need to customize the bot flow, you need to modify the class `NexmoConnector.php`. This class extends from the ChatbotConnector and here you can override all the parent methods.


### STRUCTURE

The `NexmoConnector` folder has some classes needed to use the ChatbotConnector with Nexmo. These classes are used in the NexmoConnector constructor in order to provide the application with the components needed to send information to Nexmo and to parse messages between WhatsApp, ChatbotAPI and HyperChat.

**External API folder**

Inside this folder there is the Nexmo API client which allows the bot to send messages and handle authorization events.


**External Digester folder**

This folder contains the class NexmoDigester. This class is a kind of "translator" between the Chatbot API and WhatsApp. Mainly, the work performed by this class is to convert a message from the Chatbot API into a message accepted by the Nexmo API. It also does the inverse work, translating messages from Nexmo into the format required by the Chatbot API.


**HyperChat API**

The class `NexmoHyperChatClient` instantiates a Nexmo client from the `external_id` parameter provided by HyperChat. This parameter is generated by the external client and passed to HyperChat when the chat is created. This parameter allows us to instantiate a new Nexmo client from WhatsApp phone numbers that is extracted from the external_id:
```php
    //Instances an external client
    protected function instanceExternalClient($externalId, $appConf)
    {
        $userNumber = NexmoAPIClient::getUserNumberFromExternalId($externalId);
        if (is_null($userNumber)) {
            return null;
        }
        $companyNumber = NexmoAPIClient::getCompanyNumberFromExternalId($externalId);
        if (is_null($companyNumber)) {
            return null;
        }
        $externalClient = new NexmoAPIClient($appConf->get('nexmo.auth'));
        if ($appConf->get('sandbox.endpoint')) {
            $externalClient->setEndpoint($appConf->get('sandbox.endpoint'));
        }
        $externalClient->setSenderFromId($companyNumber, $userNumber);
        return $externalClient;
    }
```

This class extends from the class `HyperChatClient` that extends from the default HyperChatClient provided by the product team, and all the parent methods can be overwritten.
